# Development Dockerfile
FROM golang:1.25-alpine AS development

# Install system dependencies
RUN apk add --no-cache \
    git \
    curl \
    nodejs \
    npm \
    su-exec

# Create user and home directory for proper permissions
RUN adduser -D -u 1000 -g 1000 user && \
    mkdir -p /home/user/.cache/go-build && \
    mkdir -p /go/pkg/mod && \
    mkdir -p /go/bin && \
    chown -R 1000:1000 /home/user && \
    chown -R 1000:1000 /go/pkg/mod && \
    chown -R 1000:1000 /go/bin

# Install development tools
RUN go install github.com/air-verse/air@latest
RUN go install github.com/a-h/templ/cmd/templ@latest
RUN go install github.com/magefile/mage@latest
# Install trgen from local source using mage (after copying source code)
# This will be done after COPY step

# Set working directory
WORKDIR /app

# Copy go mod files
COPY go.mod go.sum ./

# Download dependencies
RUN go mod download

# Copy source code with proper ownership
COPY --chown=1000:1000 . .

# Install trgen using mage with proper versioning
RUN mage generator:install

RUN cd demo && npm install
# Generate Templ code using trgen
RUN trgen --scan-path demo/app --module-name github.com/denkhaus/templ-router

# Build Tailwind CSS
RUN mage build:tailwindClean

# Copy and setup entrypoint script
COPY docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Expose port
EXPOSE 8084

# Default command (can be overridden in docker-compose)
ENTRYPOINT ["/entrypoint.sh"]
CMD ["mage", "dev"]
